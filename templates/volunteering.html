<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Volunteering</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="header">
    <a href="/">
        <img src="{{ url_for('static', filename='images/logo-Sh.png') }}" alt="Logo" class="logo">
    </a>
    <h2 style="text-align:center; color: #dc3545">Volunteering</h2>
    <div class="nav-buttons">
        <a href="{{ url_for('volunteers') }}" class="nav-button">Volunteers</a>
        <a href="{{ url_for('volunteering') }}" class="nav-button">Volunteering</a>
        <a href="{{ url_for('rides') }}" class="nav-button">Rides</a>
    </div>
</div>

<!-- טופס הוספה / עדכון / חיפוש / מחיקה -->
<form method="POST" action="{{ url_for('volunteering') }}" class="volunteer-form-grid" id="volForm">
    <input type="hidden" name="volunteering_id" id="volunteering_id"
           value="{{ volunteering_data.volunteering_id if volunteering_data else '' }}">
    <div class="form-top-bar">
        <div class="form-info-text">
            To search/update an existing volunteer, please enter a date, location and hour.
        </div>

        <div class="form-buttons-row">
            <label>&nbsp;</label>
            <button type="submit" name="action" value="search" class="update-button" id="search-btn"
                    onclick="return setAction()">
                {{ 'Delete' if volunteering_data else 'Search' }}
            </button>


            <button type="submit" name="action" value="update" class="update-button" id="add-btn"
                    style="display: inline;">{% if volunteering_data %}Update{% else %}Add{% endif %}
            </button>

            <button type="button" class="update-button" onclick="clearForm()">Clear</button>
        </div>
    </div>

    <div class="form-field">
        <label>Date</label>
        <input type="date" name="date" id="date"
               value="{{ volunteering_data.date if volunteering_data else '' }}" required>
    </div>

    <div class="form-field">
        <label>Hour</label>
        <input type="number" name="hour" id="hour" min="0" max="23"
               value="{{ volunteering_data.hour if volunteering_data else '' }}" required>
    </div>

    <div class="form-field" style="margin-left: -55px; width: 80px">
        <label>Duration</label>
        <input type="number" name="duration" id="duration" min="0"
               value="{{ volunteering_data.duration if volunteering_data else '' }}">
    </div>

    <div class="form-field" style="margin-left: -130px; width: 180px">
        <label>Location</label>
        <select name="location" id="location" required>
            <option value="" disabled {% if not volunteering_data %}selected{% endif %}>Select</option>
            {% for cid in city_ids %}
            <option value="{{ cid }}" {% if volunteering_data and volunteering_data.location== cid %}selected{% endif
                    %}>
                {{ cid }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-field" style="margin-left: -105px; width: 120px">
        <label>Patient ID</label>
        <select name="patient_id" id="patient_id">
            <option value="" disabled {% if not volunteering_data %}selected{% endif %}>Select</option>
            {% for pid in patient_ids %}
            <option value="{{ pid }}" {% if volunteering_data and volunteering_data.patient_id== pid %}selected{% endif
                    %}>
                {{ pid }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-field" style="margin-left: -140px; width: 200px">
        <label>Type</label>
        <select name="type" id="type">
            <option value="" disabled {% if not volunteering_data %}selected{% endif %}>Select</option>
            {% for kid in kindOfVol_ids %}
            <option value="{{ kid }}" {% if volunteering_data and volunteering_data.type== kid %}selected{% endif %}>
                {{ kid }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="Report-form-field" style="margin-left: -95px;">
        <label>Report</label>
        <input type="text" name="report" id="report"
               value="{{ volunteering_data.report if volunteering_data else '' }}">
    </div>
</form>

<p style="margin-left: 10px; color: #919191;">
    Clicking on the ambulance will open the linked trip. If you want to add a trip, click on the X.
    Clicking on the person icon will show the volunteers participating in the volunteering.
</p>

<div class="Volunteering-scroll-table-wrapper" style="height: 300px">
    <table class="scroll-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Hour</th>
            <th>Duration</th>
            <th>Location</th>
            <th>Patient ID</th>
            <th>Type</th>
            <th>Report</th>
            <th>Ride</th>
            <th>Volunteers</th>
        </tr>
        </thead>
        <tbody>
        {% for v in volunteering %}
        <tr>
            <td>{{ v[0] }}</td>
            <td>{{ v[1] }}</td>
            <td>{{ v[2] }}</td>
            <td>{{ v[3] }}</td>
            <td>{{ v[4] }}</td>
            <td>{{ v[5] }}</td>
            <td>{{ v[6] }}</td>
            <td>{{ v[7] }}</td>
            <td>
                {% if v[8] %}
                <a href="{{ url_for('view_ride', volunteering_id=v[0]) }}">
                    <img src="{{ url_for('static', filename='images/ambulance.png') }}" alt="Ride" width="24">
                </a>
                {% else %}
                <a href="#" onclick="handleAddRide({{ v[0] }})">
                    <img src="{{ url_for('static', filename='images/x-icon.png') }}" alt="Add Ride" width="20">
                </a>
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('volunteers_of_volunteering', volunteering_id=v[0]) }}">
                    <img src="{{ url_for('static', filename='images/person-icon.png') }}" alt="Volunteers" width="22">
                </a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function handleAddRide(volId) {
        if (confirm("Do you want to add a ride to this volunteering?")) {
            window.location.href = "/add_ride/" + volId;
        }
    }

     function clearForm() {
        const form = document.getElementById("volForm");

        // איפוס כל שדות הטופס
        form.reset();

        // איפוס ערכים ידנית לכל select
        const selects = form.querySelectorAll("select");
        selects.forEach(select => {
            select.selectedIndex = 0;
        });

        // איפוס כל input ידני (כולל value שהוגדר ע"י Jinja)
        const inputs = form.querySelectorAll("input[type='text'], input[type='number'], input[type='date']");
        inputs.forEach(input => {
            input.value = "";
        });

        // איפוס שדה ה־ID הסמוי
        document.getElementById("volunteering_id").value = "";

        // עדכון כפתור חיפוש
        const searchBtn = document.getElementById("search-btn");
        searchBtn.textContent = "Search";
        searchBtn.value = "search";

        // עדכון כפתור Add
        const addBtn = document.getElementById("add-btn");
        addBtn.textContent = "Add";
        addBtn.value = "add";
    }

    function setAction() {
        const volId = document.getElementById("volunteering_id").value;
        const searchBtn = document.getElementById("search-btn");

        // אם יש volunteering_id – המשמעות היא שזו תוצאה קיימת → מציעים למחוק
        if (volId) {
            if (confirm("Are you sure you want to delete this volunteering and its related data (ride + participants)?")) {
                searchBtn.value = "delete";
                return true;
            } else {
                return false;
            }
        }

        // אחרת – מבצעים חיפוש רגיל
        searchBtn.value = "search";
        return true;
    }

</script>
{% if error_message %}
<script>
    window.onload = function () {
        alert("{{ error_message }}");
    }
</script>
{% endif %}
</body>
</html>
